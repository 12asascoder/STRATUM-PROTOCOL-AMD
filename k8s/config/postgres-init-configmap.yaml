apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-script
  namespace: stratum-protocol
data:
  init.sql: |
    -- PostgreSQL initialization script for STRATUM PROTOCOL
    
    -- Create databases
    CREATE DATABASE IF NOT EXISTS stratum_main;
    CREATE DATABASE IF NOT EXISTS stratum_ledger;
    CREATE DATABASE IF NOT EXISTS stratum_timeseries;
    
    -- Connect to main database
    \c stratum_main;
    
    -- Enable extensions
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "postgis";
    
    -- Infrastructure nodes table
    CREATE TABLE IF NOT EXISTS infrastructure_nodes (
        node_id VARCHAR(255) PRIMARY KEY,
        node_type VARCHAR(100) NOT NULL,
        location JSONB,
        capacity FLOAT,
        current_load FLOAT,
        health_status VARCHAR(50),
        criticality_score FLOAT,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
    );
    
    -- Infrastructure dependencies table
    CREATE TABLE IF NOT EXISTS infrastructure_dependencies (
        id SERIAL PRIMARY KEY,
        source_node_id VARCHAR(255) REFERENCES infrastructure_nodes(node_id),
        target_node_id VARCHAR(255) REFERENCES infrastructure_nodes(node_id),
        dependency_type VARCHAR(100),
        strength FLOAT,
        bidirectional BOOLEAN DEFAULT FALSE,
        created_at TIMESTAMP DEFAULT NOW()
    );
    
    -- Create indexes
    CREATE INDEX IF NOT EXISTS idx_nodes_type ON infrastructure_nodes(node_type);
    CREATE INDEX IF NOT EXISTS idx_nodes_criticality ON infrastructure_nodes(criticality_score DESC);
    CREATE INDEX IF NOT EXISTS idx_deps_source ON infrastructure_dependencies(source_node_id);
    CREATE INDEX IF NOT EXISTS idx_deps_target ON infrastructure_dependencies(target_node_id);
